<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="http://jsbsim.sf.net/JSBSimScript.xsl"?>
<runscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://jsbsim.sf.net/JSBSimScript.xsd"
    name="UAM Crosswind Landing Analysis">

  <description>
    UAM 기체 횡풍 조건 착륙 시뮬레이션
    Urban Air Mobility Crosswind Landing Simulation
    
    분석 목적:
    - 다양한 횡풍 조건에서 UAM 기체의 착륙 성능 평가
    - 좌우 편차(lateral deviation) 정량적 분석
    - 안전 운항 기준 수립을 위한 데이터 생성
  </description>

  <use aircraft="uam_quadcopter" initialize="reset01"/>

  <!-- 대기 모델 설정 -->
  <atmosphere>
    <turb_type> ttBerndt </turb_type>
    <turb_rate> 10 </turb_rate>
    <turb_gain> 1.0 </turb_gain>
  </atmosphere>

  <!-- 시뮬레이션 설정 -->
  <run start="0.0" end="60.0" dt="0.02">

    <!-- 초기 조건 (착륙 접근 상황) -->
    <property value="0.0"> ic/long-gc-deg </property>
    <property value="0.0"> ic/lat-gc-deg </property>
    <property value="328.0"> ic/h-agl-ft </property>     <!-- 100m 고도 -->
    <property value="65.6"> ic/u-fps </property>          <!-- 20 m/s 전진속도 -->
    <property value="0.0"> ic/v-fps </property>           <!-- 측방향 속도 0 -->
    <property value="-6.56"> ic/w-fps </property>         <!-- -2 m/s 하강속도 -->
    <property value="0.0"> ic/phi-deg </property>         <!-- 롤각 0 -->
    <property value="-3.0"> ic/theta-deg </property>      <!-- 피치각 -3도 (접근각) -->
    <property value="0.0"> ic/psi-true-deg </property>    <!-- 요각 0 -->
    <property value="0.0"> ic/p-rad_sec </property>       <!-- 롤각속도 0 -->
    <property value="0.0"> ic/q-rad_sec </property>       <!-- 피치각속도 0 -->
    <property value="0.0"> ic/r-rad_sec </property>       <!-- 요각속도 0 -->

    <!-- 횡풍 조건 설정 (시나리오별로 변경 가능) -->
    <property value="26.24"> atmosphere/wind-north-fps </property>  <!-- 8 m/s 북풍 -->
    <property value="26.24"> atmosphere/wind-east-fps </property>   <!-- 8 m/s 동풍 -->
    <property value="0.0"> atmosphere/wind-down-fps </property>     <!-- 수직풍 0 -->

    <!-- 추력 설정 (일정한 추력으로 접근) -->
    <property value="0.6"> fcs/throttle-cmd-norm[0] </property>
    <property value="0.6"> fcs/throttle-cmd-norm[1] </property>
    <property value="0.6"> fcs/throttle-cmd-norm[2] </property>
    <property value="0.6"> fcs/throttle-cmd-norm[3] </property>

    <!-- 자동제어 활성화 -->
    <event name="Enable Autopilot">
      <condition> simulation/sim-time-sec ge 1.0 </condition>
      <set name="ap/autopilot-engage" value="1"/>
      <set name="ap/attitude_hold" value="1"/>
      <set name="ap/heading_hold" value="1"/>
      <notify/>
    </event>

    <!-- 롤각 제어 (수평 유지) -->
    <event name="Roll Control" persistent="true">
      <condition> simulation/sim-time-sec ge 1.0 </condition>
      <set name="fcs/aileron-cmd-norm" 
           value="-2.0 * attitude/phi-rad - 0.5 * velocities/p-rad_sec"/>
      <clipto>
        <min>-1.0</min>
        <max>1.0</max>
      </clipto>
    </event>

    <!-- 요각 제어 (방향 유지) -->
    <event name="Yaw Control" persistent="true">
      <condition> simulation/sim-time-sec ge 1.0 </condition>
      <set name="fcs/rudder-cmd-norm" 
           value="-1.0 * attitude/psi-rad - 0.3 * velocities/r-rad_sec"/>
      <clipto>
        <min>-1.0</min>
        <max>1.0</max>
      </clipto>
    </event>

    <!-- 고도 제어 (일정한 하강률 유지) -->
    <event name="Altitude Control" persistent="true">
      <condition> simulation/sim-time-sec ge 1.0 </condition>
      <set name="fcs/elevator-cmd-norm" 
           value="0.1 * (velocities/w-fps + 6.56) - 0.2 * attitude/theta-rad"/>
      <clipto>
        <min>-0.5</min>
        <max>0.5</max>
      </clipto>
    </event>

    <!-- 착륙 감지 및 종료 -->
    <event name="Landing Detection">
      <condition> position/h-agl-ft le 5.0 </condition>
      <set name="simulation/terminate" value="1"/>
      <notify>
        <property> position/lat-gc-deg </property>
        <property> position/long-gc-deg </property>
        <property> position/h-agl-ft </property>
        <property> velocities/u-fps </property>
        <property> velocities/v-fps </property>
        <property> velocities/w-fps </property>
        <property> attitude/phi-deg </property>
        <property> attitude/theta-deg </property>
        <property> attitude/psi-deg </property>
      </notify>
    </event>

    <!-- 측방편차 모니터링 -->
    <event name="Lateral Deviation Monitor" persistent="true">
      <condition> simulation/sim-time-sec ge 0.0 </condition>
      <set name="metrics/lateral-deviation-ft" value="position/distance-from-start-lat-mt * 3.28084"/>
      <notify format="CSV" file="lateral_deviation.csv">
        <property> simulation/sim-time-sec </property>
        <property> position/lat-gc-deg </property>
        <property> position/long-gc-deg </property>
        <property> position/h-agl-ft </property>
        <property> metrics/lateral-deviation-ft </property>
        <property> velocities/v-fps </property>
        <property> attitude/phi-deg </property>
        <property> attitude/psi-deg </property>
        <property> aero/beta-deg </property>
        <property> atmosphere/wind-north-fps </property>
        <property> atmosphere/wind-east-fps </property>
      </notify>
    </event>

    <!-- 임계 편차 경고 -->
    <event name="Critical Deviation Warning">
      <condition> abs(metrics/lateral-deviation-ft) ge 100.0 </condition>
      <notify>
        <property caption="WARNING: Critical lateral deviation detected!"> 
          metrics/lateral-deviation-ft 
        </property>
        <property> simulation/sim-time-sec </property>
        <property> atmosphere/wind-north-fps </property>
        <property> atmosphere/wind-east-fps </property>
      </notify>
    </event>

  </run>

  <!-- 출력 파일 설정 -->
  <output name="crosswind_data.csv" type="CSV" rate="10">
    <simulation> OFF </simulation>
    <atmosphere> ON </atmosphere>
    <massprops> ON </massprops>
    <aerosurfaces> ON </aerosurfaces>
    <rates> ON </rates>
    <velocities> ON </velocities>
    <forces> ON </forces>
    <moments> ON </moments>
    <position> ON </position>
    <coefficients> ON </coefficients>
    <ground_reactions> ON </ground_reactions>
    <fcs> ON </fcs>
    <propulsion> ON </propulsion>
    
    <property title="Time"> simulation/sim-time-sec </property>
    <property title="Altitude_ft"> position/h-agl-ft </property>
    <property title="Latitude_deg"> position/lat-gc-deg </property>
    <property title="Longitude_deg"> position/long-gc-deg </property>
    
    <!-- 속도 -->
    <property title="U_fps"> velocities/u-fps </property>
    <property title="V_fps"> velocities/v-fps </property>
    <property title="W_fps"> velocities/w-fps </property>
    <property title="Vtotal_fps"> velocities/vt-fps </property>
    
    <!-- 자세각 -->
    <property title="Phi_deg"> attitude/phi-deg </property>
    <property title="Theta_deg"> attitude/theta-deg </property>
    <property title="Psi_deg"> attitude/psi-deg </property>
    
    <!-- 각속도 -->
    <property title="P_radsec"> velocities/p-rad_sec </property>
    <property title="Q_radsec"> velocities/q-rad_sec </property>
    <property title="R_radsec"> velocities/r-rad_sec </property>
    
    <!-- 공기역학각 -->
    <property title="Alpha_deg"> aero/alpha-deg </property>
    <property title="Beta_deg"> aero/beta-deg </property>
    
    <!-- 풍속 정보 -->
    <property title="Wind_North_fps"> atmosphere/wind-north-fps </property>
    <property title="Wind_East_fps"> atmosphere/wind-east-fps </property>
    <property title="Wind_Mag_fps"> atmosphere/wind-mag-fps </property>
    
    <!-- 제어 입력 -->
    <property title="Aileron_norm"> fcs/aileron-pos-norm </property>
    <property title="Elevator_norm"> fcs/elevator-pos-norm </property>
    <property title="Rudder_norm"> fcs/rudder-pos-norm </property>
    <property title="Throttle_norm"> fcs/throttle-pos-norm[0] </property>
    
    <!-- 측방편차 -->
    <property title="Lateral_Deviation_ft"> metrics/lateral-deviation-ft </property>
    
    <!-- 공기역학적 힘과 모멘트 -->
    <property title="Lift_lbs"> forces/fwz-lbs </property>
    <property title="Drag_lbs"> forces/fwx-lbs </property>
    <property title="Side_lbs"> forces/fwy-lbs </property>
    <property title="Roll_Moment_ftlb"> moments/l-total-lbsft </property>
    <property title="Pitch_Moment_ftlb"> moments/m-total-lbsft </property>
    <property title="Yaw_Moment_ftlb"> moments/n-total-lbsft </property>
    
  </output>

</runscript>